From 7f7388f7ce57ec5b75eb695d4c477bdc5d8e18ea Mon Sep 17 00:00:00 2001
From: Sabeur DAMAK <damak.sabeur@gmail.com>
Date: Mon, 6 May 2024 15:49:35 +0200
Subject: [PATCH] amlogic-FROMLIST-v1-ASoC-meson-axg-tdm-interface-add-frame-r

---
 sound/soc/meson/axg-tdm-interface.c | 24 +++++++++++++++++-------
 1 file changed, 17 insertions(+), 7 deletions(-)

diff --git a/sound/soc/meson/axg-tdm-interface.c b/sound/soc/meson/axg-tdm-interface.c
index cd5168e826df..465bdcf44a12 100644
--- a/sound/soc/meson/axg-tdm-interface.c
+++ b/sound/soc/meson/axg-tdm-interface.c
@@ -153,19 +153,29 @@ static int axg_tdm_iface_startup(struct snd_pcm_substream *substream,
 		return -EINVAL;
 	}
 
-	/* Apply component wide rate symmetry */
 	if (snd_soc_component_active(dai->component)) {
+		/* Apply component wide rate symmetry */
 		ret = snd_pcm_hw_constraint_single(substream->runtime,
 						   SNDRV_PCM_HW_PARAM_RATE,
 						   iface->rate);
-		if (ret < 0) {
-			dev_err(dai->dev,
-				"can't set iface rate constraint\n");
-			return ret;
-		}
+
+	} else {
+		/* Limit rate according to the slot number and width */
+		unsigned int max_rate =
+			MAX_SCLK / (iface->slots * iface->slot_width);
+		ret = snd_pcm_hw_constraint_minmax(substream->runtime,
+						   SNDRV_PCM_HW_PARAM_RATE,
+						   0, max_rate);
 	}
 
-	return 0;
+	if (ret < 0) {
+		dev_err(dai->dev, "can't set iface rate constraint\n");
+		
+	} else
+	{
+		ret = 0;
+   }
+	return (ret);
 }
 
 static int axg_tdm_iface_set_stream(struct snd_pcm_substream *substream,
-- 
2.34.1

